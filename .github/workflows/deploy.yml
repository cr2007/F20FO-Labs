name: Deploy Typst PDF to Pages

on:
  push:
    branches: ["main"]

  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true
      - name: Setup Typst
        uses: typst-community/setup-typst@v4

      - name: Ensure yq is available
        run: |
          if ! command -v yq &> /dev/null; then
            sudo wget -qO /usr/local/bin/yq \
              https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi

      - name: Prepare metadata.yml
        env:
          STUDENT_FIRST_NAME: ${{ secrets.STUDENT_FIRST_NAME }}
          STUDENT_LAST_NAME:  ${{ secrets.STUDENT_LAST_NAME }}
          STUDENT_EMAIL:      ${{ secrets.STUDENT_EMAIL }}
        run: |
          mv example.metadata.yml metadata.yml

          yq -i '
            .studentFirstName = strenv(STUDENT_FIRST_NAME) |
            .studentLastName  = strenv(STUDENT_LAST_NAME)  |
            .studentEmail     = strenv(STUDENT_EMAIL)
          ' metadata.yml

      - name: Compile Typst to PDF
        run: |
          mkdir -p dist
          for lab in Lab*/Lab*.typ; do
            lab_name=$(basename "$lab" .typ)
            typst compile "$lab" "dist/$lab_name.pdf"
          done

      - name: Generate centered index.html
        run: |
            cat > dist/index.html <<'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="utf-8" />
                <title>Labs</title>
                <style>
                    :root {
                        --bg: #ffffff;
                        --fg: #111111;
                        --link: #0066cc;
                    }

                    @media (prefers-color-scheme: dark) {
                        :root {
                        --bg: #0d1117;
                        --fg: #c9d1d9;
                        --link: #58a6ff;
                        }
                    }

                    body {
                        margin: 0;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: var(--bg);
                        color: var(--fg);
                        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
                    }

                    .container {
                        text-align: center;
                    }

                    ul {
                        list-style: none;
                        padding: 0;
                        margin: 1rem 0 0;
                    }

                    li {
                        margin: 0.5rem 0;
                    }

                    a {
                        color: var(--link);
                        text-decoration: none;
                        font-size: 1.1rem;
                    }

                    a:hover {
                        text-decoration: underline;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                <h1>Labs</h1>
                <ul>
            EOF

            for pdf in dist/*.pdf; do
            name=$(basename "$pdf")
            echo "            <li><a href=\"$name\">$name</a></li>" >> dist/index.html
            done

            cat >> dist/index.html <<'EOF'
                </ul>
                </div>
            </body>
            </html>
            EOF


      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
